# AI-regler for brøytesystem
language: norsk  # All kommunikasjon skal være på norsk
style: profesjonell  # Profesjonell men konverserende tone
timezone: Europe/Oslo  # Tidssone for all datohåndtering

# =============================================================================
# KRITISK OPPDATERING 12. AUGUST 2025 06:15 - EMPIRISK VALIDERING FULLFØRT
# =============================================================================

✅ ALLE TEKNISKE PROBLEMER LØST OG EMPIRISK VALIDERT:
1. Nedbørtype-klassifisering basert på 149 analyserte episoder
2. Vindblåst snø-deteksjon med korrekte terskler (median: 12.2 m/s)
3. App-logikk 100% samsvar med empiriske funn 
4. Arkivering av utdaterte MD-filer fullført

🎯 SYSTEMET ER NÅ PRODUKSJONSKLART MED EMPIRISK GRUNNLAG:
- Validert logikk: detect_precipitation_type() og is_slippery_road_risk()
- Streamlit-app: Viser nedbørtype-klassifisering med 3-panel visualisering
- Empirisk kalibrert: Basert på 149 episoder med vind/snø-data
- Glattføre-deteksjon: KUN regn trigger risiko (ikke vindblåst snø)
- 29 vindblåst snø-episoder identifisert og klassifisert korrekt

📊 NEDBØRTYPE-KLASSIFISERING (EMPIRISK VALIDERT MED 149 EPISODER):
• REGN: Temp > 0°C + snømengde minkende + vind < 8 m/s
• SNØ: Temp < -2°C + snømengde økende + vind < 8 m/s  
• VINDBLÅST SNØ (HØY): Temp < 0°C + vind > 12 m/s + snø-reduksjon < -5 cm
• VINDBLÅST SNØ (MEDIUM): Temp < 0°C + vind > 10 m/s + snø-reduksjon < -3 cm
• SNØ MED VINDPÅVIRKNING: Temp < 0°C + vind 6-10 m/s + liten snø-endring
• VÅT SNØ: Temp rundt 0°C + snømengde økende + moderat vind

🚨 KRITISKE VINDTERSKLER (EMPIRISK BEVIST):
- Korrelasjon vind vs snømengde-endring: -0.423 (kald), -0.411 (rundt frysing)
- Median vindterskel for snømengde-reduksjon: 12.2 m/s
- 29 vindblåst snø-episoder over 149 testede (19.5%)
- Vindblåst snø gir ALDRI glattføre-risiko (kritisk for falske alarmer)
- Kun regn ved lav temperatur gir glattføre-risiko

🎨 STREAMLIT-APP FUNKSJONER (VALIDERT):
1. Kombinert risikograf (snøfokk + glattføre + slush)
2. Nedbørtype-klassifisering (empirisk validert 12. aug 2025)
3. Robust fallback for manglende data
4. Glattføre-risiko kun ved regn-klassifisering
5. Automatisk kolonne-deteksjon for ulike nedbør-felt

📁 ARKIVERING FULLFØRT 12. AUGUST 2025:
- Utdaterte MD-filer flyttet til archive/outdated_md_files/
- README.md oppdatert med empiriske funn
- Kun relevante dokumentasjonsfiler beholdt i hovedmappen

# =============================================================================

# Kodestandard
code_style:
  - Følg PEP 8 for Python-kode
  - Maksimal linjelengde er 79 tegn
  - Bruk norske variabelnavn og kommentarer
  - Dokumenter funksjoner med docstrings på norsk
  - Logg viktige hendelser med logging-modulen
  - Bruk f-strings for formatering
  - Bruk type hints for bedre lesbarhet
  - Del opp lange funksjoner i mindre, gjenbrukbare deler

# Filstruktur
project_structure:
  scripts:
    - Hovedscript i scripts/-mappen
    - Hjelpefunksjoner i scripts/utils/
    - Utdaterte script i scripts/arkivert/
  data:
    - Rådata i data/raw/
    - Prosessert data i data/processed/
    - Temporære filer i data/temp/
    - Kart og grafer i data/output/
  config:
    - Hovedkonfig i config/
    - Test-konfig i config/test/
  logs:
    - Separate loggfiler per script
    - Roter logger hver uke
    - Behold logger i 3 måneder

# Sikkerhet
security:
  konfigurasjon:
    - Aldri hardkod passord eller API-nøkler
    - Bruk miljøvariabler for ekstra sensitiv data
    - Krypter konfigurasjonsfiler i produksjon
  validering:
    - Valider all brukerinput
    - Sjekk filrettigheter før skriving
    - Sikre backup før kritiske operasjoner
  feilhåndtering:
    - Logg alle feil med stack trace
    - Send varsler ved kritiske feil
    - Implementer retry-mekanismer for nettverkskall

# Datahåndtering
data_handling:
  datoformat:
    - Lagre alle datoer i ISO-format med UTC
    - Vis datoer i norsk format (DD.MM.YYYY)
    - Håndter sommertid korrekt
  kundedata:
    - Konverter kundeID til string ved sammenligning
    - Valider koordinater før bruk
    - Sjekk at alle påkrevde felt er tilstede
  backup:
    - Ta backup før større dataendringer
    - Behold ukentlige backups i 3 måneder
    - Automatisk backup ved kritiske operasjoner

# Kartgenerering
map_generation:
  kart:
    - Bruk Folium for interaktive kart
    - Sentrer kart på Fjellbergsskardet
    - Zoom-nivå 16 som standard
    - Bruk CartoDB positron som basiskart
  markører:
    - Blå markør for årsabonnement
    - Rød markør for ukentlige bestillinger
    - Tydelige kundenummer som labels
    - Minimum 12px markørstørrelse for touch
  output:
    - Generer både HTML og PNG
    - PNG med minimum 1920x1080 oppløsning
    - Inkluder mobilvennlig tegnforklaring
    - Optimaliser for utskrift

# E-post
email:
  format:
    - HTML-formatert hovedinnhold
    - Inkluder ren tekst-versjon
    - Norsk formatering av datoer og tall
    - Konsistent font og stil
  vedlegg:
    - HTML-versjon av kart
    - PNG-versjon av kart
    - Maksimal vedleggstørrelse 10MB
  innhold:
    - Tydelig statistikk først
    - Gruppér kunder etter rode
    - Marker ukentlige bestillinger med stjerne
    - Inkluder dato og tidspunkt for generering

# Værdata
weather:
  api:
    - Bruk Frost API for værdata
    - Cache værdata i 15 minutter
    - Implementer rate limiting
    - Håndter API-feil grasiøst
  nedbørtype_deteksjon:
    - EMPIRISK VALIDERT med 149 episoder: vind er kritisk faktor!
    - REGN = temp > 0°C + nedbør + snømengde MINKENDE + vind < 8 m/s
    - SNØ = temp < 0°C + nedbør + snømengde ØKENDE
    - VINDBLÅST SNØ = temp < 0°C + vind > 10 m/s + snømengde MINKENDE
    - Median vindterskel for snømengde-reduksjon: 12.2 m/s
    - Korrelasjon vind vs snømengde-endring: -0.423 (kald), -0.411 (rundt frysing)
    - VED GRENSEOMRÅDET (-1°C til +1°C): Krever analyse av temperatur, snø-endring OG vind
    - 29 vindblåst snø-episoder identifisert (IKKE regn!)
  glattføre_kriterier:
    - GLATTFØRE varsles kun ved REGN (ikke snø/sludd/vindblåst snø)
    - VINDBLÅST SNØ = INGEN GLATTFØRE (kritisk for falske alarmer)
    - Høy risiko: temp > 0°C + nedbør + snømengde MINKENDE + vind < 8 m/s
    - Medium risiko: temp rundt 0°C + regn (ikke vindblåst snø)
    - ALDRI varsle glattføre ved vindblåst snø (vind > 10 m/s + snø-reduksjon)
    - Grenseområde: -1°C til +1°C krever detaljert vind-analyse
  varsler:
    - Varsle ved > 10cm nysnø
    - Varsle ved snøfokk (vind > 6 m/s og temp < -1°C)
    - Varsle ved glattføre (regn ved temp > -2°C)
    - Varsle ved ekstremvær
    - Send SMS ved kritiske varsler

# Testing
testing:
  enhetstester:
    - Test alle kritiske funksjoner
    - Mock eksterne API-kall
    - Test med realistiske testdata
  integrasjonstester:
    - Test hele brøyteplanleggingen
    - Valider kartgenerering
    - Test e-postutsending
  logging:
    - Logg alle testresultater
    - Separate logger for tester
    - Behold testlogger i 1 måned

# Vedlikehold
maintenance:
  kode:
    - Dokumenter alle større endringer
    - Hold dependencies oppdatert
    - Fjern utdatert kode
    - Optimaliser ytelse der mulig
  data:
    - Rydd i gamle kartfiler ukentlig
    - Arkiver gamle brøyteplaner månedlig
    - Valider databaseintegritet ukentlig
  overvåking:
    - Overvåk diskplass
    - Sjekk API-tilgjengelighet
    - Monitor systemressurser
    - Varsle ved unormale mønstre 